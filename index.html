<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login</title>
  <style>
    :root { --bg:#000; --text:#fff; --pill:#fff; --pillText:#000; }
    * { box-sizing: border-box; }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font-family: Arial, Helvetica, sans-serif;
      min-height:100vh; display:flex; flex-direction:column;
    }

    /* Header mit 3 Logos */
    .header {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px; gap:10px;
    }
    .header img { height:80px; width:auto; object-fit:contain; }

    /* Info-Box: Nutzung.html */
    .info-wrap { width:100%; display:flex; justify-content:center; padding:10px 12px; }
    .info-card {
      width:100%; max-width:800px; background:#fff; color:#111;
      border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,.35);
      overflow:hidden; border:1px solid rgba(0,0,0,.2);
    }
    .info-card iframe { width:100%; border:0; display:block; background:#fff; }

    /* Login-Inhalt */
    .wrap {
      flex:1; display:flex; flex-direction:column; align-items:center; gap:14px;
      padding:12px;
    }
    .row {
      display:flex; align-items:center; gap:12px; width:100%;
      max-width:560px;
    }
    .pill {
      background:var(--pill); color:var(--pillText);
      padding:10px 16px; border-radius:14px; font-weight:bold; min-width:110px;
      text-align:center; white-space:nowrap;
    }
    .input {
      flex:1; background:var(--pill); color:#111;
      border:none; border-radius:10px; padding:12px 14px; font-size:16px;
      outline:none;
    }
    .login-btn {
      background:#fff; color:#000; border:none; border-radius:16px;
      padding:10px 24px; font-size:18px; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.35); margin-top:6px;
    }
    .login-btn[disabled]{ opacity:.6; cursor:default; }
    .msg {
      width:100%; max-width:560px; min-height:40px;
      background:#fff; color:#111; border-radius:6px;
      display:flex; align-items:center; padding:8px 10px; margin-top:6px;
      font-size:14px;
    }
    .msg.empty { background:rgba(255,255,255,.12); color:#ddd; border:1px solid #333; }

    @media (max-width:480px){
      .header img{ height:36px; }
      .pill{ min-width:96px; padding:8px 12px; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <img id="logo-left" src="pluslogo.png" alt="Logo links">
    <img id="logo-center" src="faust.jpg" alt="Logo Mitte">
    <img id="logo-right" src="melsungen.jpg" alt="Logo rechts">
  </div>

  <!-- Nutzung.html oben einblenden -->
  <div class="info-wrap">
    <div class="info-card">
      <iframe id="nutzungFrame" src="Nutzung.html" title="Nutzung / Hinweise"></iframe>
    </div>
  </div>

  <!-- Login-Form -->
  <div class="wrap">
    <div class="row">
      <div class="pill">E-Mail</div>
      <input id="user" class="input" type="email" autocomplete="username" />
    </div>

    <div class="row">
      <div class="pill">Passwort</div>
      <input id="pass" class="input" type="password" autocomplete="current-password" />
    </div>

    <button class="login-btn" id="loginBtn">Login</button>
    <div id="msg" class="msg empty"> </div>
  </div>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

  <script>
    // ---------- Firebase Init ----------
    firebase.initializeApp({
      apiKey: "AIzaSyAoucj3QxDwUQTfnDQSgjJpzsetsUYTUY0",
      authDomain: "login-wtplus.firebaseapp.com",
      projectId: "login-wtplus",
      storageBucket: "login-wtplus.firebasestorage.app",
      messagingSenderId: "763050920283",
      appId: "1:763050920283:web:c35f46da2192d11badb27e"
    });
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // Login nur für diese Sitzung
    auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

    // ---------- Auto-Weiterleitung, wenn schon angemeldet ----------
    auth.onAuthStateChanged((user) => {
      if (user) {
        // Rolle holen, falls noch nicht gesetzt
        if (!sessionStorage.getItem("role")) {
          db.collection("rollen").doc(user.uid).get().then((snap)=>{
            const role = (snap.exists ? (snap.data().role||"user") : "user").toLowerCase();
            sessionStorage.setItem("role", role);
            sessionStorage.setItem("loggedInUser", user.email || "");
            location.href = "hauptseite.html";
          }).catch(()=>{
            sessionStorage.setItem("role","user");
            sessionStorage.setItem("loggedInUser", user.email || "");
            location.href = "hauptseite.html";
          });
        } else {
          location.href = "hauptseite.html";
        }
      }
    });

    // ---------- Nutzung.html iFrame-Höhe ----------
    (function autosizeNutzung(){
      const frame = document.getElementById("nutzungFrame");
      frame.addEventListener("load", () => {
        try {
          const doc = frame.contentDocument || frame.contentWindow.document;
          const h = Math.max(
            doc.body.scrollHeight, doc.documentElement.scrollHeight,
            doc.body.offsetHeight, doc.documentElement.offsetHeight
          );
          frame.style.height = (h || 300) + "px";
        } catch(e) {
          frame.style.height = "360px";
        }
      });
    })();

    // ---------- UI-Helfer ----------
    const $ = (s)=>document.querySelector(s);
    const msg = (t, ok=false)=>{
      const box = $("#msg");
      box.textContent = t || " ";
      box.classList.toggle("empty", !t);
      box.style.background = ok ? "#e7ffe7" : "#fff";
    };

    // ---------- Login ----------
    $("#user").addEventListener("keydown", e => { if (e.key === "Enter") $("#pass").focus(); });
    $("#pass").addEventListener("keydown", e => { if (e.key === "Enter") doLogin(); });
    $("#loginBtn").addEventListener("click", doLogin);

    async function doLogin(){
      const email = $("#user").value.trim();
      const pass  = $("#pass").value;
      if (!email || !pass) { msg("Bitte E-Mail und Passwort eingeben."); return; }

      const btn = $("#loginBtn");
      btn.disabled = true; msg("Anmeldung …");

      try {
        // 1) Auth bei Firebase
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        const uid  = cred.user.uid;

        // 2) Rolle aus Firestore
        const snap = await db.collection("rollen").doc(uid).get();
        const role = (snap.exists ? (snap.data().role||"user") : "user").toLowerCase();

        // 3) Session speichern
        sessionStorage.setItem("loggedInUser", email);
        sessionStorage.setItem("role", role);

        msg("Erfolgreich angemeldet.", true);
        setTimeout(()=> location.href = "hauptseite.html", 300);

      } catch (err) {
        console.error("[Login Fehler]", err);
        let human = "Login fehlgeschlagen.";
        if (err.code === "auth/invalid-email") human = "E-Mail-Adresse ist ungültig.";
        else if (err.code === "auth/user-disabled") human = "Konto ist deaktiviert.";
        else if (err.code === "auth/user-not-found" || err.code === "auth/wrong-password") human = "E-Mail oder Passwort falsch.";
        msg(human);
      } finally {
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
